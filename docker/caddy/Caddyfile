# https://caddyserver.com/docs/caddyfile
{
	admin off
	email {$TLS_EMAIL}
}

(common) {
	header {
		?Referrer-Policy "same-origin"
		-Server
		?Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		?X-Content-Type-Options "nosniff"
		?X-Frame-Options "DENY"
	}

	encode gzip
}

(common_with_error_handling) {
	import common

	handle_errors {
		import common
	}
}

# Redirect "www" to "non-www"
www.{$DOMAIN_NAME} {
	import common_with_error_handling

	redir https://{$DOMAIN_NAME}{uri}
}

{$DOMAIN_NAME} {
	import common_with_error_handling

	handle_path /static/* {
		# STATIC_ROOT
		root * /var/www/django/static
		file_server {
			precompressed br gzip
		}
	}

	handle_path /media/* {
		# MEDIA_ROOT
		root * /var/www/django/media
		file_server
	}

	handle {
		reverse_proxy django:5000
	}
}
